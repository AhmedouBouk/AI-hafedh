{% extends 'schedule/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <div class="table-responsive">
        <table class="table table-bordered table-hover">
            <thead class="sticky-top bg-light">
                <tr>
                    <th>CodeEM</th>
                    <th>Titre</th>
                    <th>Cr√©dits EM</th>
                    <th>Coefficient</th>
                    <th>CM</th>
                    <th>TD</th>
                    <th>TP</th>
                    <th>MP</th>
                    <th>VHT EM</th>
                    <th>CM</th>
                    <th>TD</th>
                    <th>TP</th>
                    <th>MP</th>
                    <th>Salle_CM</th>
                    <th>Salle_TP</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="courseTableBody">
                {% for course in courses %}
                <tr data-course-id="{{ course.id }}">
                    <td class="editable" data-field="code">{{ course.code }}</td>
                    <td class="editable" data-field="title">{{ course.title }}</td>
                    <td class="editable" data-field="credits">{{ course.credits }}</td>
                    <td class="editable" data-field="coefficient">{{ course.coefficient|default:'' }}</td>
                    <td class="editable" data-field="cm_hours">{{ course.cm_hours }}</td>
                    <td class="editable" data-field="td_hours">{{ course.td_hours }}</td>
                    <td class="editable" data-field="tp_hours">{{ course.tp_hours }}</td>
                    <td class="editable" data-field="mp_hours">{{ course.mp_hours|default:'0' }}</td>
                    <td class="editable" data-field="vht">{{ course.vht|default:'' }}</td>
                    <td class="editable" data-field="cm_professor">
                        {% for assignment in course.courseassignment_set.all %}
                            {% if assignment.type == 'CM' %}{{ assignment.professor.name }}{% endif %}
                        {% endfor %}
                    </td>
                    <td class="editable" data-field="td_professor">
                        {% for assignment in course.courseassignment_set.all %}
                            {% if assignment.type == 'TD' %}{{ assignment.professor.name }}{% endif %}
                        {% endfor %}
                    </td>
                    <td class="editable" data-field="tp_professor">
                        {% for assignment in course.courseassignment_set.all %}
                            {% if assignment.type == 'TP' %}{{ assignment.professor.name }}{% endif %}
                        {% endfor %}
                    </td>
                    <td class="editable" data-field="mp_professor">
                        {% for assignment in course.courseassignment_set.all %}
                            {% if assignment.type == 'MP' %}{{ assignment.professor.name }}{% endif %}
                        {% endfor %}
                    </td>
                    <td class="editable" data-field="cm_room">
                        {% for assignment in course.courseassignment_set.all %}
                            {% if assignment.type == 'CM' %}{{ assignment.room.number }}{% endif %}
                        {% endfor %}
                    </td>
                    <td class="editable" data-field="tp_room">
                        {% for assignment in course.courseassignment_set.all %}
                            {% if assignment.type == 'TP' %}{{ assignment.room.number }}{% endif %}
                        {% endfor %}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary edit-row">
                            <i class="fas fa-edit" style="color: #0d6efd;"></i>
                        </button>
                        <button class="btn btn-sm btn-danger delete-row">
                            <i class="fas fa-trash" style="color: #dc3545;"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <button id="addNewRow" class="btn btn-success mt-3">
        <i class="fas fa-plus"></i> Add New Course
    </button>
</div>

<style>
    .table-responsive {
        max-height: calc(100vh - 150px);
        overflow-y: auto;
    }
    
    .sticky-top {
        position: sticky;
        top: 0;
        z-index: 1;
        background-color: #f8f9fa;
    }
    
    .editable:hover {
        background-color: #f8f9fa;
        cursor: pointer;
    }
    
    .editing {
        padding: 0 !important;
    }
    
    .editing input {
        width: 100%;
        height: 100%;
        border: none;
        padding: 8px;
        background-color: #fff;
    }

    .btn-sm {
        padding: 0.25rem 0.5rem;
        border: none;
        background: transparent;
    }

    .btn-sm:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }

    .btn-primary i {
        color: #0d6efd !important;
    }

    .btn-danger i {
        color: #dc3545 !important;
    }
</style>
{% endblock %}

{% block extrajs %}
<script>
$(document).ready(function() {
    // Make cells editable on click
    $('.editable').on('click', function() {
        if (!$(this).hasClass('editing')) {
            const value = $(this).text().trim();
            const input = $('<input type="text">').val(value);
            $(this).html(input).addClass('editing');
            input.focus();
        }
    });

    // Handle input blur
    $(document).on('blur', '.editing input', function() {
        const cell = $(this).parent();
        const newValue = $(this).val();
        cell.html(newValue).removeClass('editing');
        
        // Save changes to database
        const courseId = cell.parent().data('course-id');
        const field = cell.data('field');
        
        $.ajax({
            url: '{% url "update_course" %}',
            method: 'POST',
            data: {
                course_id: courseId,
                field: field,
                value: newValue,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    toastr.success('Updated successfully');
                } else {
                    toastr.error('Update failed');
                    // Revert the change if update failed
                    cell.html(response.original_value);
                }
            },
            error: function() {
                toastr.error('Update failed');
            }
        });
    });

    // Add new row
    $('#addNewRow').on('click', function() {
        const newRow = $('<tr>').append(
            '<td class="editable" data-field="code"></td>' +
            '<td class="editable" data-field="title"></td>' +
            '<td class="editable" data-field="credits"></td>' +
            '<td class="editable" data-field="coefficient"></td>' +
            '<td class="editable" data-field="cm_hours"></td>' +
            '<td class="editable" data-field="td_hours"></td>' +
            '<td class="editable" data-field="tp_hours"></td>' +
            '<td class="editable" data-field="mp_hours"></td>' +
            '<td class="editable" data-field="vht"></td>' +
            '<td class="editable" data-field="cm_professor"></td>' +
            '<td class="editable" data-field="td_professor"></td>' +
            '<td class="editable" data-field="tp_professor"></td>' +
            '<td class="editable" data-field="mp_professor"></td>' +
            '<td class="editable" data-field="cm_room"></td>' +
            '<td class="editable" data-field="tp_room"></td>' +
            '<td>' +
            '<button class="btn btn-sm btn-primary edit-row"><i class="fas fa-edit" style="color: #0d6efd;"></i></button>' +
            '<button class="btn btn-sm btn-danger delete-row"><i class="fas fa-trash" style="color: #dc3545;"></i></button>' +
            '</td>'
        );
        
        $('#courseTableBody').append(newRow);
        newRow.find('td:first').click(); // Start editing the first cell
    });

    // Delete row
    $(document).on('click', '.delete-row', function() {
        const row = $(this).closest('tr');
        const courseId = row.data('course-id');
        
        if (confirm('Are you sure you want to delete this course?')) {
            $.ajax({
                url: '{% url "delete_course" %}',
                method: 'POST',
                data: {
                    course_id: courseId,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.success) {
                        row.remove();
                        toastr.success('Course deleted successfully');
                    } else {
                        toastr.error('Failed to delete course');
                    }
                },
                error: function() {
                    toastr.error('Failed to delete course');
                }
            });
        }
    });
});
</script>
{% endblock %}
