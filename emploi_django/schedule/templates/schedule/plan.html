{% extends 'schedule/base.html' %}

{% block title %}Plan de l'emploi du temps{% endblock %}

{% block extra_css %}
<style>
    .plan-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .plan-table th, .plan-table td {
        border: 1px solid #ddd;
        padding: 8px;
        position: relative;
        min-width: 120px;
    }
    
    .plan-table th {
        background-color: #f8f9fa;
        text-align: center;
        font-weight: bold;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .plan-table td:first-child,
    .plan-table th:first-child {
        position: sticky;
        left: 0;
        background-color: #f8f9fa;
        z-index: 5;
        font-weight: bold;
        min-width: 100px;
    }
    
    .plan-table td:nth-child(2),
    .plan-table th:nth-child(2) {
        position: sticky;
        left: 100px;
        background-color: #f8f9fa;
        z-index: 5;
        font-weight: bold;
        min-width: 60px;
    }
    
    .plan-cell {
        min-height: 40px;
        padding: 5px;
        cursor: pointer;
    }
    
    .plan-cell.cm {
        background-color: #90EE90;  /* Light green */
    }
    
    .plan-cell.td {
        background-color: #FFB6C1;  /* Light red */
    }
    
    .plan-cell.tp {
        background-color: #87CEEB;  /* Light blue */
    }
    
    .plan-cell.selected {
        outline: 2px solid #007bff;
    }
    
    .soutenance {
        background-color: #FFE4B5;  /* Light orange */
    }
    
    .military {
        background-color: #E6E6FA;  /* Light purple */
    }
    
    .table-container {
        overflow-x: auto;
        max-height: 80vh;
        margin-top: 20px;
    }
    
    .period-cell {
        font-weight: bold;
        text-align: center;
    }
    
    .day-cell {
        font-weight: bold;
        background-color: #f8f9fa;
    }
    
    .week-header {
        background-color: #2c3e50;
        color: white;
        text-align: center;
        padding: 10px;
        position: sticky;
        top: 0;
        z-index: 15;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="table-container">
        <table class="plan-table">
            <thead>
                <tr>
                    <th>Jour</th>
                    <th>Période</th>
                    {% for week in weeks %}
                        <th>S{{ week }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for day in days %}
                    {% for period in periods %}
                        <tr>
                            {% if forloop.first %}
                                <td class="day-cell" rowspan="4">{{ day.1 }}</td>
                            {% endif %}
                            <td class="period-cell">P{{ forloop.counter }}</td>
                            {% for week in weeks %}
                                <td class="plan-cell"
                                    id="cell_{{ day.0 }}_P{{ forloop.parentloop.counter }}_{{ week }}"
                                    onclick="selectCell(this)"
                                    data-day="{{ day.0 }}"
                                    data-period="P{{ forloop.parentloop.counter }}"
                                    data-week="{{ week }}">
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Course Selection Modal -->
<div class="modal fade" id="courseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sélectionner un cours</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <select class="form-select" id="courseSelect">
                        <option value="">Sélectionner un cours</option>
                    </select>
                </div>
                <div class="btn-group w-100">
                    <button class="btn btn-success" onclick="addCourse('CM')">CM</button>
                    <button class="btn btn-danger" onclick="addCourse('TD')">TD</button>
                    <button class="btn btn-info" onclick="addCourse('TP')">TP</button>
                </div>
                <div class="mt-3">
                    <button class="btn btn-warning w-100" onclick="addSpecial('SOUTENANCE')">Soutenance Stage</button>
                    <button class="btn btn-secondary w-100 mt-2" onclick="addSpecial('MILITARY')">Encadrement militaire</button>
                    <button class="btn btn-danger w-100 mt-2" onclick="clearCell()">Effacer</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let selectedCell = null;
    const courseModal = new bootstrap.Modal(document.getElementById('courseModal'));
    
    function loadCourses() {
        $.get('/api/courses/', function(data) {
            const select = $('#courseSelect');
            select.empty();
            select.append('<option value="">Sélectionner un cours</option>');
            data.forEach(course => {
                select.append(`<option value="${course.code}">${course.code} - ${course.title}</option>`);
            });
        });
    }
    
    function selectCell(cell) {
        if (selectedCell) {
            selectedCell.classList.remove('selected');
        }
        selectedCell = cell;
        cell.classList.add('selected');
        courseModal.show();
    }
    
    function addCourse(type) {
        if (!selectedCell || !$('#courseSelect').val()) return;
        
        const courseCode = $('#courseSelect').val();
        selectedCell.innerHTML = `${courseCode}-${type}`;
        selectedCell.className = `plan-cell ${type.toLowerCase()}`;
        courseModal.hide();
        savePlan();
    }
    
    function addSpecial(type) {
        if (!selectedCell) return;
        
        if (type === 'SOUTENANCE') {
            selectedCell.innerHTML = 'Soutenance Stage';
            selectedCell.className = 'plan-cell soutenance';
        } else if (type === 'MILITARY') {
            selectedCell.innerHTML = 'Encadrement militaire';
            selectedCell.className = 'plan-cell military';
        }
        
        courseModal.hide();
        savePlan();
    }
    
    function clearCell() {
        if (!selectedCell) return;
        selectedCell.innerHTML = '';
        selectedCell.className = 'plan-cell';
        courseModal.hide();
        savePlan();
    }
    
    function savePlan() {
        const plan = [];
        document.querySelectorAll('.plan-cell').forEach(cell => {
            if (cell.innerHTML && !cell.innerHTML.includes('Soutenance') && !cell.innerHTML.includes('Encadrement')) {
                const [courseCode, type] = cell.innerHTML.split('-');
                plan.push({
                    week: cell.dataset.week,
                    day: cell.dataset.day,
                    period: cell.dataset.period,
                    course_code: courseCode,
                    type: type
                });
            }
        });
        
        $.ajax({
            url: '/api/plan/save/',
            method: 'POST',
            data: JSON.stringify({ plan: plan }),
            contentType: 'application/json',
            success: function() {
                console.log('Plan saved successfully');
            },
            error: function() {
                alert('Error saving plan');
            }
        });
    }
    
    function loadPlan() {
        // Load plan for all weeks at once
        $.get('/api/plan/all/', function(data) {
            // Clear all cells
            document.querySelectorAll('.plan-cell').forEach(cell => {
                cell.innerHTML = '';
                cell.className = 'plan-cell';
            });
            
            // Fill cells with data
            data.forEach(item => {
                const cell = document.querySelector(
                    `#cell_${item.day}_${item.period}_${item.week}`
                );
                if (cell) {
                    if (item.type === 'SOUTENANCE') {
                        cell.innerHTML = 'Soutenance Stage';
                        cell.className = 'plan-cell soutenance';
                    } else if (item.type === 'MILITARY') {
                        cell.innerHTML = 'Encadrement militaire';
                        cell.className = 'plan-cell military';
                    } else {
                        cell.innerHTML = `${item.course_code}-${item.type}`;
                        cell.className = `plan-cell ${item.type.toLowerCase()}`;
                    }
                }
            });
        });
    }
    
    // Initial load
    loadCourses();
    loadPlan();
</script>
{% endblock %}
